# Fleetbase API
upstream fleetbase {
    server localhost:3000;
}

# Frappe/ERPNext
upstream frappe {
    server localhost:8000;
}

# Socket.IO for Frappe
upstream frappe_socketio {
    server localhost:9000;
}

server {
    listen 80;
    server_name _;

    # Always-available landing page (so reverse proxy doesn't 502 while ERPNext is still initializing)
    location = / {
        default_type text/html;
        return 200 "<!doctype html><html><head><meta charset='utf-8'><title>ANOKHA Stack</title></head><body><h2>ANOKHA stack is starting</h2><ul><li><a href='/api/fleetbase/'>Fleetbase API (via Nginx)</a></li><li><a href='/erp/'>ERPNext (via Nginx)</a> (may take a few minutes on first boot)</li><li>Direct: <a href='http://localhost:3000/health'>Fleetbase health</a>, <a href='http://localhost:8000'>ERPNext</a></li></ul></body></html>";
    }

    # Fleetbase API endpoints
    location /api/fleetbase/ {
        proxy_pass http://fleetbase/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Frappe/ERPNext behind /erp/
    location /erp/ {
        proxy_intercept_errors on;
        error_page 502 503 504 = /erp-starting;
        rewrite ^/erp/?(.*)$ /$1 break;
        proxy_pass http://frappe;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    location = /erp-starting {
        default_type text/html;
        return 200 "<!doctype html><html><head><meta charset='utf-8'><title>ERPNext Starting</title></head><body><h2>ERPNext is still starting</h2><p>First boot can take several minutes while Frappe/ERPNext installs.</p><p>Try again in a few minutes: <a href='/erp/'>/erp/</a></p></body></html>";
    }

    # Socket.IO endpoint
    location /socket.io/ {
        proxy_pass http://frappe_socketio;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
